<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Beranda | X-Ceria</title>
    <link
      href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="main-layout">
      <aside>
        <div
          style="
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
          "
        >
          <img
            src="https://cdn-icons-png.flaticon.com/512/2395/2395796.png"
            class="logo-icon bouncing-icon"
            alt="Logo X-Ceria"
          />
          X-Ceria
        </div>
        <nav>
          <a href="feed.html" class="menu-item active">
            <i class="ri-home-7-fill"></i>
            <span>Beranda</span>
          </a>
          <a href="search.html" class="menu-item">
            <i class="ri-earth-line"></i>
            <span>Jelajah</span>
          </a>
          <a href="profile.html" class="menu-item">
            <i class="ri-user-3-line"></i>
            <span>Profil</span>
          </a>
          <a href="chat.html" class="menu-item">
            <i class="ri-message-3-line"></i>
            <span>Pesan</span>
          </a>
        </nav>
        <button
          onclick="logout()"
          class="btn"
          style="
            margin-top: 20px;
            background: #ffb7b2;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
          "
        >
          <i class="ri-logout-box-r-line"></i>
          Keluar
        </button>
      </aside>

      <main>
        <div class="card">
          <h3>Apa yang seru hari ini? âœ¨</h3>
          <textarea id="content" placeholder="Ceritain dong..."></textarea>
          <input type="file" id="fileInput" />
          <button onclick="posting()" class="btn btn-small">
            Kirim Cerita
          </button>
        </div>

        <div id="feedList"></div>
      </main>

      <aside>
        <div class="saweria-widget">
          <div class="trending-text">
            <h3>Trending ðŸ”¥</h3>

            <a href="#" class="trending-item">#BelajarFlask</a>
            <a href="#" class="trending-item">#pwp membuatmu gila</a>
            <a href="#" class="trending-item">#CodingSeru</a>
            <a href="#" class="trending-item">#Lelah</a>
            <a href="#" class="trending-item">#KerjaLembur</a>

            <small
              style="
                display: block;
                margin-top: 15px;
                font-size: 12px;
                opacity: 0.7;
              "
            >
              yang lagi naik daun di X-Ceria
            </small>
          </div>

          <img
            src="https://cdn-icons-png.flaticon.com/512/1864/1864514.png"
            class="widget-mascot"
            alt="Maskot"
          />
        </div>
      </aside>
    </div>

    <div id="commentModal" class="modal-overlay">
      <div class="modal-box">
        <div class="modal-header">
          <h3>Komentar <span id="commentCount">0</span> ðŸ’¬</h3>
          <button onclick="closeModal()" class="btn-close">X</button>
        </div>

        <div id="modalList" class="modal-body"></div>

        <div class="modal-footer">
          <small
            id="replyingToBadge"
            style="
              display: none;
              color: #f8c300;
              font-weight: bold;
              margin-bottom: 5px;
            "
          >
            Membalas...
            <span onclick="cancelReply()" style="cursor: pointer; color: red"
              >(Batal)</span
            >
          </small>

          <div style="display: flex; gap: 10px">
            <input
              type="text"
              id="commentInput"
              placeholder="Tulis komentar..."
              style="margin: 0"
            />
            <input type="hidden" id="activeTweetId" />
            <input type="hidden" id="activeParentId" />
            <button
              onclick="sendComment()"
              class="btn btn-small"
              style="width: auto"
            >
              ðŸš€
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const user = JSON.parse(localStorage.getItem("user"));
      if (!user) window.location.href = "index.html";

      function logout() {
        localStorage.removeItem("user");
        window.location.href = "index.html";
      }

      function isVideo(filename) {
        return filename.match(/\.(mp4|mov|avi|wmv|flv|mkv)$/i);
      }

      // --- 1. FITUR MENTION (UBAH TEKS JADI LINK BIRU) ---
      function formatMention(text) {
        return text.replace(
          /@(\w+)/g,
          '<span style="color:#007bff; font-weight:bold; cursor:pointer;">@$1</span>'
        );
      }

      // --- LOAD FEED ---
      async function loadFeed() {
        try {
          const res = await fetch(`/api/tweets/?my_id=${user.id}`);
          const result = await res.json();
          const list = document.getElementById("feedList");
          list.innerHTML = "";

          if (!result.data) return; // Jaga-jaga kalau error

          result.data.forEach((t) => {
            let mediaHtml = "";
            if (t.image_url) {
              mediaHtml = isVideo(t.image_url)
                ? `<video controls class="feed-video"><source src="${t.image_url}"></video>`
                : `<img src="${t.image_url}" style="width:100%; border-radius:10px; border:2px solid black; margin-top:10px;">`;
            }

            const heartIcon = t.is_liked
              ? "ri-heart-3-fill"
              : "ri-heart-3-line";
            const heartColor = t.is_liked ? "color:#ff4757;" : "color:black;";
            const formattedContent = formatMention(t.content);

            list.innerHTML += `
                <div class="card">
                    <div style="display:flex; justify-content:space-between;">
                        <div style="display:flex; gap:10px; align-items:center;">
                            <div style="width:35px; height:35px; background:#f8c300; border-radius:50%; border:2px solid black; display:flex; justify-content:center; align-items:center;">
                                <b>${t.username[0].toUpperCase()}</b>
                            </div>
                            <div>
                                <b>${t.full_name}</b>
                                <small style="color:#888;">@${
                                  t.username
                                }</small>
                            </div>
                        </div>
                        <small>${new Date(
                          t.created_at
                        ).toLocaleDateString()}</small>
                    </div>

                    <p style="margin-top:10px; font-size:16px;">${formattedContent}</p>
                    ${mediaHtml}

                    <div style="margin-top:15px; display:flex; gap:20px; border-top:2px dashed #eee; padding-top:10px;">
                        <span onclick="toggleLike(${
                          t.id
                        })" style="cursor:pointer; font-size:18px; font-weight:bold; ${heartColor}">
                            <i class="${heartIcon}" style="font-size:20px;"></i> ${
              t.total_likes
            }
                        </span>
                        <span onclick="openComments(${
                          t.id
                        })" style="cursor:pointer; font-size:18px; font-weight:bold;">
                            <i class="ri-chat-3-line" style="font-size:20px;"></i> ${
                              t.total_comments
                            }
                        </span>
                    </div>
                </div>`;
          });
        } catch (e) {
          console.log(e);
        }
      }

      async function toggleLike(tweetId) {
        await fetch("/api/tweets/like", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id: user.id, tweet_id: tweetId }),
        });
        loadFeed();
      }

      // --- KOMENTAR SYSTEM ---

      async function openComments(tweetId) {
        document.getElementById("commentModal").style.display = "flex";
        document.getElementById("activeTweetId").value = tweetId;
        cancelReply();
        loadComments(tweetId);
      }

      function closeModal() {
        document.getElementById("commentModal").style.display = "none";
        loadFeed();
      }

      async function loadComments(tweetId) {
        const list = document.getElementById("modalList");
        const res = await fetch(`/api/comments/${tweetId}?my_id=${user.id}`);
        const result = await res.json();

        document.getElementById("commentCount").innerText = result.data.length;
        list.innerHTML = "";

        if (result.data.length === 0) {
          list.innerHTML =
            "<p align='center' style='color:#ccc'>Belum ada komentar.</p>";
          return;
        }

        const parents = result.data.filter(
          (c) => !c.parent_id || c.parent_id == 0
        );
        parents.forEach((parent) => {
          list.innerHTML += renderHTML(parent, false);
          const replies = result.data.filter((c) => c.parent_id === parent.id);
          replies.forEach((reply) => {
            list.innerHTML += renderHTML(reply, true);
          });
        });
      }

      function renderHTML(c, isReply) {
        const cssClass = isReply ? "comment-item reply-item" : "comment-item";
        const contentFormatted = formatMention(c.content);
        let deleteBtn = "";

        if (c.username === user.username) {
          deleteBtn = `<span onclick="deleteComment(${c.id})" style="cursor:pointer; color:red; margin-left:10px;" title="Hapus"><i class="ri-delete-bin-line"></i></span>`;
        }

        const heartIcon = c.is_liked ? "ri-heart-fill" : "ri-heart-line";
        const heartColor = c.is_liked ? "color:red;" : "color:#888;";

        return `
            <div class="${cssClass}">
                <div style="display:flex; justify-content:space-between;">
                    <div><strong>@${c.username}</strong> ${deleteBtn}</div>
                    <small style="color:#888;">${new Date(
                      c.created_at
                    ).toLocaleDateString()}</small>
                </div>
                
                <p style="margin:5px 0;">${contentFormatted}</p>
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
                    <span onclick="toggleCommentLike(${
                      c.id
                    })" style="cursor:pointer; font-size:14px; ${heartColor}">
                        <i class="${heartIcon}"></i> ${c.total_likes}
                    </span>

                    ${
                      !isReply
                        ? `<span class="btn-reply" onclick="setReply(${c.id}, '@${c.username}')">â†ª Balas</span>`
                        : ""
                    }
                </div>
            </div>
        `;
      }

      async function toggleCommentLike(commentId) {
        await fetch("/api/comments/like", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id: user.id, comment_id: commentId }),
        });
        const tweetId = document.getElementById("activeTweetId").value;
        loadComments(tweetId);
      }

      async function deleteComment(commentId) {
        if (!confirm("Hapus komentar ini?")) return;
        const res = await fetch(`/api/comments/${commentId}`, {
          method: "DELETE",
        });
        if (res.ok) {
          const tweetId = document.getElementById("activeTweetId").value;
          loadComments(tweetId);
        }
      }

      function setReply(parentId, username) {
        document.getElementById("activeParentId").value = parentId;
        document.getElementById("replyingToBadge").style.display = "block";
        document.getElementById(
          "replyingToBadge"
        ).innerHTML = `Membalas ke ${username} <span onclick="cancelReply()" style="cursor:pointer; color:red;">(x)</span>`;
        document.getElementById("commentInput").focus();
      }

      function cancelReply() {
        document.getElementById("activeParentId").value = "";
        document.getElementById("replyingToBadge").style.display = "none";
      }

      async function sendComment() {
        const tweetId = document.getElementById("activeTweetId").value;
        const parentId =
          document.getElementById("activeParentId").value || null;
        const content = document.getElementById("commentInput").value;

        if (!content) return;

        await fetch("/api/comments/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_id: user.id,
            tweet_id: tweetId,
            content: content,
            parent_id: parentId,
          }),
        });
        document.getElementById("commentInput").value = "";
        cancelReply();
        loadComments(tweetId);
      }

      async function posting() {
        const content = document.getElementById("content").value;
        const file = document.getElementById("fileInput").files[0];

        if (!user) {
          alert("Kamu belum login!");
          window.location.href = "index.html";
          return;
        }

        const formData = new FormData();
        formData.append("user_id", user.id);
        formData.append("content", content);
        if (file) formData.append("file", file);

        const res = await fetch("/api/tweets/", {
          method: "POST",
          body: formData,
        });

        if (res.ok) {
          document.getElementById("content").value = "";
          document.getElementById("fileInput").value = "";
          loadFeed();
        } else {
          alert("Gagal posting");
        }
      }

      loadFeed();
    </script>
  </body>
</html>
