<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Profil Saya | X-Ceria</title>
    <link
      href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="main-layout">
      <aside>
        <div
          style="
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
          "
        >
          <img
            src="https://cdn-icons-png.flaticon.com/512/2395/2395796.png"
            class="logo-icon bouncing-icon"
            alt="Logo X-Ceria"
          />
          X-Ceria
        </div>
        <nav>
          <a href="feed.html" class="menu-item">
            <img
              src="https://cdn-icons-png.flaticon.com/512/2413/2413074.png"
              class="menu-icon"
            />
            Beranda
          </a>
          <a href="search.html" class="menu-item">
            <img
              src="https://cdn-icons-png.flaticon.com/512/2909/2909565.png"
              class="menu-icon"
            />
            Jelajah
          </a>
          <a href="profile.html" class="menu-item">
            <img
              src="https://cdn-icons-png.flaticon.com/512/3069/3069172.png"
              class="menu-icon"
            />
            Profil
          </a>
        </nav>
        <button
          onclick="logout()"
          class="btn"
          style="
            margin-top: 20px;
            background: #ffb7b2;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
          "
        >
          <img
            src="https://cdn-icons-png.flaticon.com/512/4034/4034229.png"
            class="menu-icon"
            style="width: 24px; height: 24px"
          />
          Keluar
        </button>
      </aside>

      <main>
        <div class="card" style="text-align: center">
          <div
            style="
              width: 80px;
              height: 80px;
              background: #f8c300;
              border-radius: 50%;
              border: 3px solid black;
              margin: 0 auto;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 40px;
            "
          >
            <i class="ri-user-star-fill"></i>
          </div>
          <h2 style="margin-top: 10px" id="dispName">...</h2>
          <p id="dispUser" style="color: #666">@...</p>

          <div
            style="
              display: flex;
              justify-content: center;
              gap: 30px;
              margin-top: 20px;
              border-top: 2px dashed #ccc;
              padding-top: 15px;
            "
          >
            <div>
              <b style="font-size: 20px" id="statPost">0</b><br />
              <small>Postingan</small>
            </div>
            <div>
              <b style="font-size: 20px" id="statFollower">0</b><br />
              <small>Pengikut</small>
            </div>
            <div>
              <b style="font-size: 20px" id="statFollowing">0</b><br />
              <small>Mengikuti</small>
            </div>
          </div>
        </div>

        <h3 style="margin-bottom: 15px">Postingan Saya ðŸ‘‡</h3>
        <div id="myPostList"></div>
      </main>

      <aside>
        <div class="saweria-widget">
          <div class="trending-text">
            <h3>INfoooo</h3>

            <a href="#" class="trending-item">halaman ini</a>
            <a href="#" class="trending-item">Tempat melihat akun</a>
            <a href="#" class="trending-item">juga menghapus postingan</a>

            <small
              style="
                display: block;
                margin-top: 15px;
                font-size: 12px;
                opacity: 0.7;
              "
            >
              Dibuat oleh Tim X-Ceria &copy; 2026
            </small>
          </div>

          <img
            src="https://cdn-icons-png.flaticon.com/512/2395/2395804.png"
            class="widget-mascot"
            alt="Maskot"
          />
        </div>
      </aside>
    </div>

    <script>
      const user = JSON.parse(localStorage.getItem("user"));
      if (!user) window.location.href = "index.html";
      function logout() {
        localStorage.removeItem("user");
        window.location.href = "index.html";
      }

      document.getElementById("dispName").innerText = user.full_name;
      document.getElementById("dispUser").innerText = "@" + user.username;

      // --- FUNGSI PEMBANTU: CEK VIDEO ---
      function isVideo(filename) {
        return filename.match(/\.(mp4|mov|avi|wmv|flv|mkv)$/i);
      }

      async function loadStats() {
        const res = await fetch(`/api/users/stats/${user.id}`);
        const data = await res.json();
        if (res.ok) {
          document.getElementById("statFollower").innerText = data.followers;
          document.getElementById("statFollowing").innerText = data.following;
        }
      }

      async function loadMyPosts() {
        const res = await fetch("/api/tweets/");
        const result = await res.json();
        const list = document.getElementById("myPostList");

        const myTweets = result.data.filter(
          (t) => t.username === user.username
        );
        document.getElementById("statPost").innerText = myTweets.length;

        list.innerHTML = "";
        if (myTweets.length === 0) {
          list.innerHTML =
            "<div class='card'><p align='center'>Belum ada postingan.</p></div>";
          return;
        }

        myTweets.forEach((t) => {
          // LOGIKA BARU: Cek Gambar atau Video
          let mediaHtml = "";
          if (t.image_url) {
            if (isVideo(t.image_url)) {
              mediaHtml = `
                        <video controls class="feed-video">
                            <source src="${t.image_url}" type="video/mp4">
                        </video>`;
            } else {
              mediaHtml = `<img src="${t.image_url}" style="width:100%; border-radius:10px; border:2px solid black; margin-top:10px;">`;
            }
          }

          list.innerHTML += `
            <div class="card">
                <div style="display:flex; justify-content:space-between;">
                    <b>${t.full_name}</b>
                    <button onclick="deletePost(${t.id})" style="background:red; color:white; border:2px solid black; cursor:pointer; border-radius:5px; padding:5px 10px;">Hapus</button>
                </div>
                <p style="margin-top:10px;">${t.content}</p>
                ${mediaHtml}
                <div style="margin-top:10px; color:#888;">
                    <small><i class="ri-heart-3-fill"></i> ${t.total_likes} Likes</small>
                </div>
            </div>`;
        });
      }

      async function deletePost(id) {
        if (!confirm("Yakin hapus?")) return;
        await fetch(`/api/tweets/${id}`, { method: "DELETE" });
        loadMyPosts();
      }

      loadStats();
      loadMyPosts();
    </script>
  </body>
</html>
